<?php
/**
 * General tests for the @@PLUGIN_NAME@@ plugin
 *
 * @group plugin_@@PLUGIN_NAME@@
 * @group plugins
 */
class general_plugin_@@PLUGIN_NAME@@_test extends DokuWikiTest {

    /**
     * Simple test to make sure the plugin.info.txt is in correct format
     */
    public function test_plugininfo() {
        $file = __DIR__.'/../plugin.info.txt';
        $this->assertFileExists($file);

        $info = confToHash($file);

        $this->assertArrayHasKey('base', $info);
        $this->assertArrayHasKey('author', $info);
        $this->assertArrayHasKey('email', $info);
        $this->assertArrayHasKey('date', $info);
        $this->assertArrayHasKey('name', $info);
        $this->assertArrayHasKey('desc', $info);
        $this->assertArrayHasKey('url', $info);

        $this->assertEquals('@@PLUGIN_NAME@@', $info['base']);
        $this->assertRegExp('/^https?:\/\//', $info['url']);
        $this->assertTrue(mail_isvalid($info['email']));
        $this->assertRegExp('/^\d\d\d\d-\d\d-\d\d$/', $info['date']);
        $this->assertTrue(false !== strtotime($info['date']));
    }

    /**
     * Test to ensure that every conf['...'] entry in conf/default.php has a corresponding meta['...'] entry in
     * metadata.php.
     */
    public function test_plugin_conf() {
        $default_file = __DIR__.'/../conf/default.php';
        $meta_file    = __DIR__.'/../conf/metadata.php';

        $conf_keys = array();
        if (file_exists($default_file)) {
            $default_file = file($default_file);
            foreach ($default_file as $line) {
                $line = trim($line);
                if (substr($line,0,5) == '$conf'){
                    $limit_char = substr($line,5,1);
                    $key_end = strpos($line,$limit_char,7);
                    $conf_keys[] = substr($line,7,$key_end-7);
                }
            }
        }


        $meta_keys = array();
        if (file_exists($meta_file)) {
            $meta_file = file($meta_file);
            foreach ($meta_file as $line) {
                $line = trim($line);
                if (substr($line,0,5) == '$meta'){
                    $limit_char = substr($line,5,1);
                    $key_end = strpos($line,$limit_char,7);
                    $meta_keys[] = substr($line,7,$key_end-7);
                }
            }
        }

        foreach ($conf_keys as $key) {
            $this->assertTrue(in_array($key, $meta_keys,true),'Key $meta[\'' . $key . '\'] missing in ' . DOKU_PLUGIN .'@@PLUGIN_NAME@@/conf/metadata.php');
        }

        foreach ($meta_keys as $key) {
            $this->assertTrue(in_array($key, $conf_keys,true),'Key $conf[\'' . $key . '\'] missing in ' . DOKU_PLUGIN .'@@PLUGIN_NAME@@/conf/default.php');
        }

    }
}
